<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>📋 نظام الغياب - لوحة المدرس</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- QR Generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: #f3f4f6;
      padding: 20px;
      direction: rtl;
      text-align: center;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin: auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      cursor: pointer;
      background: #2563eb;
      color: white;
      border: none;
    }
    button:hover { background: #1d4ed8; }
    #qrCode { margin: 20px 0; }
    .attendance-item {
      border-bottom: 1px solid #eee;
      padding: 6px;
      text-align: right;
    }
  </style>
</head>
<body>

  <h2>📘 نظام الغياب - لوحة المدرس</h2>

  <div class="card">
    <label>🗓 اختر اليوم:</label>
    <select id="daySelect" onchange="loadSessions()">
      <option value="">-- اختر اليوم --</option>
      <option value="السبت">السبت</option>
      <option value="الأحد">الأحد</option>
      <option value="الإثنين">الإثنين</option>
      <option value="الثلاثاء">الثلاثاء</option>
      <option value="الأربعاء">الأربعاء</option>
      <option value="الخميس">الخميس</option>
    </select>

    <label>📚 اختر الحصة:</label>
    <select id="sessionSelect" onchange="selectSession()">
      <option value="">-- اختر الحصة --</option>
    </select>

    <div id="qrCode"></div>
    <button id="endBtn" onclick="endSession()" style="display:none;background:#ef4444;">إنهاء الحصة</button>

    <h3>👥 عدد الحاضرين: <span id="attendanceCount">0</span></h3>
    <div id="attendanceList"></div>
  </div>

  <p style="margin-top:20px;">
    <a href="https://youtube.com/@hema_tech1?si=Vz2E7UjRpTmac6iw" target="_blank">
      قناة Hema Tech
    </a>
  </p>

  <script>
    // إعداد Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f",
      measurementId: "G-HD4R7GNQ5H"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentSessionId = null;
    let qrInterval = null;

    // تحميل الحصص حسب اليوم
    async function loadSessions() {
      clearQRCode();
      const day = document.getElementById("daySelect").value;
      const select = document.getElementById("sessionSelect");
      select.innerHTML = '<option value="">-- اختر الحصة --</option>';

      if (!day) return;

      const snapshot = await db.collection("sessionsSchedule")
        .where("day", "==", day)
        .get();

      if (snapshot.empty) {
        const opt = document.createElement("option");
        opt.textContent = "❌ لا توجد حصص في هذا اليوم";
        opt.disabled = true;
        select.appendChild(opt);
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = `${data.subject || "مادة"} - ${data.class || "صف"} (${data.teacher || "مدرس مجهول"})`;
        select.appendChild(opt);
      });
    }

    // عند اختيار حصة
    function selectSession() {
      const id = document.getElementById("sessionSelect").value;
      if (!id) {
        clearQRCode();
        return;
      }
      currentSessionId = id;
      startQRCode();
      listenAttendance();
      document.getElementById("endBtn").style.display = "block";
    }

    // توليد QR كل 60 ثانية
    function startQRCode() {
      clearQRCode();
      updateQRCode();
      qrInterval = setInterval(updateQRCode, 60000);
    }

    async function updateQRCode() {
      if (!currentSessionId) return;
      const token = generateToken();
      const qrDiv = document.getElementById("qrCode");
      qrDiv.innerHTML = "";

      // الرابط اللي الطالب هيمسحه
      const qrData = `https://your-domain.com/attendance.html?session=${currentSessionId}&token=${token}`;
      QRCode.toCanvas(qrDiv, qrData, { width: 200 });

      // حفظ التوكن في الداتابيس عشان الطالب يتأكد إنه صالح
      await db.collection("sessionsSchedule").doc(currentSessionId).update({
        currentToken: token,
        lastUpdated: new Date(),
        ended: false
      });
    }

    function generateToken(length = 8) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let t = "";
      for (let i = 0; i < length; i++) t += chars.charAt(Math.floor(Math.random() * chars.length));
      return t;
    }

    // الاستماع للحضور
    function listenAttendance() {
      if (!currentSessionId) return;
      const listDiv = document.getElementById("attendanceList");

      db.collection("sessionsSchedule").doc(currentSessionId)
        .collection("attendance")
        .orderBy("time", "asc")
        .onSnapshot(snapshot => {
          listDiv.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const item = document.createElement("div");
            item.className = "attendance-item";
            item.textContent = `${data.studentName} - ${new Date(data.time.seconds * 1000).toLocaleTimeString()}`;
            listDiv.appendChild(item);
          });
          document.getElementById("attendanceCount").textContent = snapshot.size;
        });
    }

    // إنهاء الحصة
    async function endSession() {
      if (!currentSessionId) return;
      await db.collection("sessionsSchedule").doc(currentSessionId).update({
        currentToken: null,
        ended: true
      });
      alert("✅ تم إنهاء الحصة. لا يمكن تسجيل حضور جديد.");
      clearQRCode();
      document.getElementById("endBtn").style.display = "none";
    }

    // تنظيف الـ QR
    function clearQRCode() {
      if (qrInterval) clearInterval(qrInterval);
      document.getElementById("qrCode").innerHTML = "";
      document.getElementById("attendanceCount").textContent = 0;
      document.getElementById("attendanceList").innerHTML = "";
    }
  </script>
</body>
</html>






