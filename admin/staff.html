<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“‹ Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <!-- QR Generator -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body {
      font-family: "Cairo", sans-serif;
      background: #f3f4f6;
      padding: 20px;
      direction: rtl;
      text-align: center;
    }
    .card {
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      margin: auto;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      max-width: 600px;
    }
    select, button {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 16px;
    }
    button {
      cursor: pointer;
      background: #2563eb;
      color: white;
      border: none;
    }
    button:hover { background: #1d4ed8; }
    #qrCode { margin: 20px 0; }
    .attendance-item {
      border-bottom: 1px solid #eee;
      padding: 6px;
      text-align: right;
    }
  </style>
</head>
<body>

  <h2>ğŸ“˜ Ù†Ø¸Ø§Ù… Ø§Ù„ØºÙŠØ§Ø¨ - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¯Ø±Ø³</h2>

  <div class="card">
    <label>ğŸ—“ Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</label>
    <select id="daySelect" onchange="loadSessions()">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ… --</option>
      <option value="Ø§Ù„Ø³Ø¨Øª">Ø§Ù„Ø³Ø¨Øª</option>
      <option value="Ø§Ù„Ø£Ø­Ø¯">Ø§Ù„Ø£Ø­Ø¯</option>
      <option value="Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</option>
      <option value="Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</option>
      <option value="Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</option>
      <option value="Ø§Ù„Ø®Ù…ÙŠØ³">Ø§Ù„Ø®Ù…ÙŠØ³</option>
    </select>

    <label>ğŸ“š Ø§Ø®ØªØ± Ø§Ù„Ø­ØµØ©:</label>
    <select id="sessionSelect" onchange="selectSession()">
      <option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­ØµØ© --</option>
    </select>

    <div id="qrCode"></div>
    <button id="endBtn" onclick="endSession()" style="display:none;background:#ef4444;">Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­ØµØ©</button>

    <h3>ğŸ‘¥ Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ†: <span id="attendanceCount">0</span></h3>
    <div id="attendanceList"></div>
  </div>

  <p style="margin-top:20px;">
    <a href="https://youtube.com/@hema_tech1?si=Vz2E7UjRpTmac6iw" target="_blank">
      Ù‚Ù†Ø§Ø© Hema Tech
    </a>
  </p>

  <script>
    // Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBoPJbx5v6EkOqxOJkbhzHqIJdAByh79Rg",
      authDomain: "hhhhhh-d4fb8.firebaseapp.com",
      databaseURL: "https://hhhhhh-d4fb8-default-rtdb.firebaseio.com",
      projectId: "hhhhhh-d4fb8",
      storageBucket: "hhhhhh-d4fb8.appspot.com",
      messagingSenderId: "24512338206",
      appId: "1:24512338206:web:dfe045db59bd3434a2110f",
      measurementId: "G-HD4R7GNQ5H"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let currentSessionId = null;
    let qrInterval = null;

    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­ØµØµ Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ…
    async function loadSessions() {
      clearQRCode();
      const day = document.getElementById("daySelect").value;
      const select = document.getElementById("sessionSelect");
      select.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„Ø­ØµØ© --</option>';

      if (!day) return;

      const snapshot = await db.collection("sessionsSchedule")
        .where("day", "==", day)
        .get();

      if (snapshot.empty) {
        const opt = document.createElement("option");
        opt.textContent = "âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­ØµØµ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…";
        opt.disabled = true;
        select.appendChild(opt);
        return;
      }

      snapshot.forEach(doc => {
        const data = doc.data();
        const opt = document.createElement("option");
        opt.value = doc.id;
        opt.textContent = `${data.subject || "Ù…Ø§Ø¯Ø©"} - ${data.class || "ØµÙ"} (${data.teacher || "Ù…Ø¯Ø±Ø³ Ù…Ø¬Ù‡ÙˆÙ„"})`;
        select.appendChild(opt);
      });
    }

    // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø­ØµØ©
    function selectSession() {
      const id = document.getElementById("sessionSelect").value;
      if (!id) {
        clearQRCode();
        return;
      }
      currentSessionId = id;
      startQRCode();
      listenAttendance();
      document.getElementById("endBtn").style.display = "block";
    }

    // ØªÙˆÙ„ÙŠØ¯ QR ÙƒÙ„ 60 Ø«Ø§Ù†ÙŠØ©
    function startQRCode() {
      clearQRCode();
      updateQRCode();
      qrInterval = setInterval(updateQRCode, 60000);
    }

    async function updateQRCode() {
      if (!currentSessionId) return;
      const token = generateToken();
      const qrDiv = document.getElementById("qrCode");
      qrDiv.innerHTML = "";

      // Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙŠ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù‡ÙŠÙ…Ø³Ø­Ù‡
      const qrData = `https://your-domain.com/attendance.html?session=${currentSessionId}&token=${token}`;
      QRCode.toCanvas(qrDiv, qrData, { width: 200 });

      // Ø­ÙØ¸ Ø§Ù„ØªÙˆÙƒÙ† ÙÙŠ Ø§Ù„Ø¯Ø§ØªØ§Ø¨ÙŠØ³ Ø¹Ø´Ø§Ù† Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠØªØ£ÙƒØ¯ Ø¥Ù†Ù‡ ØµØ§Ù„Ø­
      await db.collection("sessionsSchedule").doc(currentSessionId).update({
        currentToken: token,
        lastUpdated: new Date(),
        ended: false
      });
    }

    function generateToken(length = 8) {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let t = "";
      for (let i = 0; i < length; i++) t += chars.charAt(Math.floor(Math.random() * chars.length));
      return t;
    }

    // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ø­Ø¶ÙˆØ±
    function listenAttendance() {
      if (!currentSessionId) return;
      const listDiv = document.getElementById("attendanceList");

      db.collection("sessionsSchedule").doc(currentSessionId)
        .collection("attendance")
        .orderBy("time", "asc")
        .onSnapshot(snapshot => {
          listDiv.innerHTML = "";
          snapshot.forEach(doc => {
            const data = doc.data();
            const item = document.createElement("div");
            item.className = "attendance-item";
            item.textContent = `${data.studentName} - ${new Date(data.time.seconds * 1000).toLocaleTimeString()}`;
            listDiv.appendChild(item);
          });
          document.getElementById("attendanceCount").textContent = snapshot.size;
        });
    }

    // Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­ØµØ©
    async function endSession() {
      if (!currentSessionId) return;
      await db.collection("sessionsSchedule").doc(currentSessionId).update({
        currentToken: null,
        ended: true
      });
      alert("âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø­ØµØ©. Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø¬Ø¯ÙŠØ¯.");
      clearQRCode();
      document.getElementById("endBtn").style.display = "none";
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù€ QR
    function clearQRCode() {
      if (qrInterval) clearInterval(qrInterval);
      document.getElementById("qrCode").innerHTML = "";
      document.getElementById("attendanceCount").textContent = 0;
      document.getElementById("attendanceList").innerHTML = "";
    }
  </script>
</body>
</html>






